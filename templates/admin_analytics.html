{% extends 'base.html' %}

{% block title %}Analytics Dashboard - EpitomeTRC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<style>
    .dashboard-card {
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 20px;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(255, 107, 0, 0.15);
    }
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    .progress-bar {
        background: linear-gradient(135deg, var(--orange) 0%, var(--orange-light) 100%);
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .metric-card {
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 10px rgba(0,0,0,0.08);
    }
    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--orange);
    }
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .metric-icon {
        font-size: 2rem;
        color: var(--orange-light);
        opacity: 0.7;
    }
    .intern-card {
        border-left: 4px solid var(--orange);
        margin-bottom: 10px;
    }
    .section-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    .section-human-resources { background-color: #17a2b8; }
    .section-business-development { background-color: #28a745; }
    .section-sales-marketing { background-color: #6f42c1; }
    .section-marketing { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Analytics Dashboard</h2>
    <div class="d-flex align-items-center">
        <form action="/admin/upload_data" method="post" enctype="multipart/form-data" class="me-3">
            <div class="input-group">
                <input type="file" class="form-control form-control-sm" id="dataFile" name="dataFile" accept=".xlsx,.csv">
                <button class="btn btn-sm btn-orange" type="submit">Upload</button>
            </div>
        </form>
        <a href="/admin/update_all_targets" class="btn btn-sm btn-success me-2">Update All Targets</a>
        <a href="/admin/delete_all_data" class="btn btn-sm btn-danger me-3" onclick="return confirm('Are you sure you want to delete all data? This action cannot be undone.');">Delete All Data</a>
        <span class="badge bg-orange">{{ now.strftime('%Y-%m-%d') }}</span>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Summary Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="metric-value">{{ metrics.total_interns }}</div>
                    <div class="metric-label">Total Interns</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="metric-value">{{ metrics.total_enrollments }}</div>
                    <div class="metric-label">Total Enrollments</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="metric-value">{{ metrics.overall_progress }}%</div>
                    <div class="metric-label">Overall Progress</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="metric-value">{{ metrics.school_lead_db }}</div>
                    <div class="metric-label">School Lead DB</div>
                </div>
                <div class="metric-icon">
                    <i class="fas fa-bullseye"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row">
    <div class="col-md-8">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Overall Performance</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="section-tab" data-bs-toggle="tab" data-bs-target="#section" type="button" role="tab">By Section</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trend-tab" data-bs-toggle="tab" data-bs-target="#trend" type="button" role="tab">Trend</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab">Comparison</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="chartTabsContent">
                    <div class="tab-pane fade show active" id="section" role="tabpanel">
                        <div class="chart-container">
                            <canvas id="sectionChart"></canvas>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="trend" role="tabpanel">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="comparison" role="tabpanel">
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Section Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Intern Performance -->
<div class="card dashboard-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-user-chart me-2"></i>Intern Performance</h5>
            <div class="d-flex">
                <div id="filterSummary" class="me-3 d-flex align-items-center">
                    <span class="badge bg-primary me-2"><span id="filteredCount">{{ interns|length }}</span> interns</span>
                    <span class="badge bg-success me-2">TND: <span id="filteredTndTotal">0</span></span>
                    <span class="badge bg-info">Category: <span id="filteredCategoryTotal">0</span></span>
                </div>
                <select class="form-select form-select-sm me-2" id="postFilter" style="width: 150px;">
                    <option value="all">All Posts</option>
                    {% for post in posts %}
                    <option value="{{ post }}">{{ post }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm me-2" id="pocFilter" style="width: 150px;">
                    <option value="all">All POCs</option>
                    {% set poc_names = [] %}
                    {% for intern in interns %}
                        {% if intern.poc_name and intern.poc_name not in poc_names %}
                            {% set _ = poc_names.append(intern.poc_name) %}
                            <option value="{{ intern.poc_name }}">{{ intern.poc_name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm" id="performanceFilter" style="width: 150px;">
                    <option value="all">All Performance</option>
                    <option value="high">High (>80%)</option>
                    <option value="medium">Medium (50-80%)</option>
                    <option value="low">Low (<50%)</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row" id="internPerformanceContainer">
            {% for intern in interns %}
            {% set entries = intern.pms_entries %}
            {% if entries|length > 0 %}
            {% set entry = entries[0] %}
            {% set tnd_achieved = (entry.ms_azure_900 or 0) + (entry.seo_starter or 0) + (entry.seo_smm or 0) + (entry.dm_crash or 0) + (entry.job_ready or 0) + (entry.azure_combo or 0) %}
            {% set tnd_target = intern.tnd_total_target or 50 %}
            {% set tnd_performance = (tnd_achieved / tnd_target * 100)|round|int if tnd_target > 0 else 0 %}
            
            {% set category_achieved = (entry.recruitment or 0) + (entry.college_db or 0) + (entry.client_db or 0) + (entry.school_lead_db or 0) %}
            {% set category_target = (intern.recruitment_target or 0) + (intern.college_db_target or 0) + (intern.client_db_target or 0) + (intern.school_lead_db_target or 0) %}
            {% set category_performance = (category_achieved / category_target * 100)|round|int if category_target > 0 else 0 %}
            
            {% set performance = tnd_performance %}
            {% set performance_class = 'bg-success' if performance >= 80 else ('bg-warning' if performance >= 50 else 'bg-danger') %}
            <div class="col-md-4 mb-3 intern-card-container" 
                 data-post="{{ intern.post }}"
                 data-poc="{{ intern.poc_name|default('') }}"
                 data-performance="{{ performance }}"
                 data-tnd-performance="{{ tnd_performance }}"
                 data-category-performance="{{ category_performance }}"
                 data-tnd-achieved="{{ tnd_achieved }}"
                 data-category-achieved="{{ category_achieved }}">
                <div class="card intern-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ intern.name }}</h6>
                            <span class="badge {{ performance_class }}">{{ performance }}%</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: {{ performance }}%;" 
                                 aria-valuenow="{{ performance }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                {% if intern.post == 'Human Resources' %}
                                <span class="badge section-badge section-human-resources">HR</span>
                                {% elif intern.post == 'Business Development' %}
                                <span class="badge section-badge section-business-development">BD</span>
                                {% elif intern.post == 'Sales & Marketing' %}
                                <span class="badge section-badge section-sales-marketing">S&M</span>
                                {% elif intern.post == 'Marketing' %}
                                <span class="badge section-badge section-marketing">Marketing</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ intern.post }}</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">POC: {{ intern.poc_name|default('N/A') }}</small>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-1">
                            <small><strong>TND:</strong> {{ tnd_achieved }}/{{ tnd_target }} ({{ tnd_performance }}%)</small>
                            <small><strong>DOJ:</strong> {{ intern.doj }}</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small><strong>Category:</strong> {{ category_achieved }}/{{ category_target }} ({{ category_performance }}%)</small>
                            <small><strong>Post:</strong> {{ intern.post }}</small>
                        </div>
                        <div class="mt-2 text-center">
                            <a href="{{ url_for('view_intern', intern_id=intern.id) }}" class="btn btn-sm w-100" style="background-color: orange;">View Details</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Complete Data Table -->
<div class="card dashboard-card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Complete Data</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="dataTable">
                <thead>
                    <tr>
                        <th>POC</th>
                        <th>Intern Name</th>
                        <th>Post</th>
                        <th>DOJ</th>
                        <th>Reference Number</th>
                        <th>Email Id</th>
                        <th>Total Enrollments</th>
                        <th>MS Azure 900</th>
                        <th>SEO Starter</th>
                        <th>SEO + SMM</th>
                        <th>DM-Crash</th>
                        <th>8Hrs Job Ready</th>
                        <th>Azure Combo</th>
                        <th>Recruitment</th>
                        <th>College DB</th>
                        <th>Client DB</th>
                        <th>School Lead DB</th>
                    </tr>
                </thead>
                <tbody>
                    {% for intern in interns %}
                    {% if intern.pms_entries|length > 0 %}
                    {% set entry = intern.pms_entries[0] %}
                    <tr>
                        <td>{{ entry.poc }}</td>
                        <td>{{ entry.intern_name }}</td>
                        <td>{{ entry.post }}</td>
                        <td>{{ entry.doj }}</td>
                        <td>{{ entry.reference_number }}</td>
                        <td>{{ entry.email_id }}</td>
                        <td>{{ entry.total_enrollments }}</td>
                        <td>{{ entry.ms_azure_900 }}</td>
                        <td>{{ entry.seo_starter }}</td>
                        <td>{{ entry.seo_smm }}</td>
                        <td>{{ entry.dm_crash }}</td>
                        <td>{{ entry.job_ready }}</td>
                        <td>{{ entry.azure_combo }}</td>
                        <td>{{ entry.recruitment }}</td>
                        <td>{{ entry.college_db }}</td>
                        <td>{{ entry.client_db }}</td>
                        <td>{{ entry.school_lead_db }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="6">Total</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='total_enrollments') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='ms_azure_900') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='seo_starter') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='seo_smm') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='dm_crash') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='job_ready') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='azure_combo') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='recruitment') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='college_db') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='client_db') }}</th>
                        <th>{{ interns|selectattr('pms_entries')|map(attribute='pms_entries')|map('first')|sum(attribute='school_lead_db') }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Team Performance with PoC Structure -->
<div class="card dashboard-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Team Performance with PoC Structure</h5>
            <div>
                <select class="form-select form-select-sm" id="teamFilter" style="width: 200px;">
                    <option value="all">All Teams</option>
                    {% for post in posts %}
                    <option value="{{ post }}">{{ post }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row" id="teamPerformanceContainer">
            {% for post in posts %}
            {% if post in team_data %}
            {% set team = team_data[post] %}
            <div class="col-md-6 mb-4 team-card" data-team="{{ post }}">
                <div class="card h-100">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ post }} Team</h6>
                        <span class="badge bg-primary">PoC: {{ team.poc.name if team.poc else 'Not Assigned' }}</span>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Team progress: {{ team.progress }}%</p>
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: {{ team.progress }}%;" 
                                 aria-valuenow="{{ team.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="mt-3">
                            {% for member in team.members %}
                            {% set entries = member.pms_entries %}
                            {% if entries|length > 0 %}
                            {% set entry = entries[0] %}
                            {% set target = 50 %}
                            {% set achieved = entry.total_enrollments or 0 %}
                            {% set performance = (achieved / target * 100)|round|int if target > 0 else 0 %}
                            {% set performance_class = 'bg-success' if performance >= 80 else ('bg-warning' if performance >= 50 else 'bg-danger') %}
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    {% if team.poc and member.id == team.poc.id %}
                                    <i class="fas fa-star text-warning me-1"></i> {{ member.name }} (PoC)
                                    {% else %}
                                    {{ member.name }}
                                    {% endif %}
                                </span>
                                <span class="badge {{ performance_class }}">{{ performance }}%</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <div>
                                <small class="d-block"><strong>Total Enrollments:</strong> {{ team.total_achieved }}</small>
                                <small class="d-block"><strong>School Lead DB:</strong> {{ team.entries|sum(attribute='school_lead_db') if team.entries else 0 }}</small>
                            </div>
                            <div>
                                <small class="d-block"><strong>College DB:</strong> {{ team.entries|sum(attribute='college_db') if team.entries else 0 }}</small>
                                <small class="d-block"><strong>Client DB:</strong> {{ team.entries|sum(attribute='client_db') if team.entries else 0 }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
    // Section Performance Chart
    const sectionCtx = document.getElementById('sectionChart').getContext('2d');
    const sectionChart = new Chart(sectionCtx, {
        type: 'bar',
        data: {
            labels: {{ section_labels|tojson }},
            datasets: [
                {
                    label: 'Target',
                    data: {{ section_targets|tojson }},
                    backgroundColor: 'rgba(200, 200, 200, 0.5)',
                    borderColor: 'rgba(200, 200, 200, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Achievement',
                    data: {{ section_achievements|tojson }},
                    backgroundColor: 'rgba(255, 107, 0, 0.5)',
                    borderColor: 'rgba(255, 107, 0, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_months|tojson }},
            datasets: {{ trend_data|tojson }}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Comparison Chart
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const comparisonChart = new Chart(comparisonCtx, {
        type: 'radar',
        data: {
            labels: {{ comparison_labels|tojson }},
            datasets: {{ comparison_data|tojson }}
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Distribution Chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    const distributionChart = new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: {{ distribution_labels|tojson }},
            datasets: [{
                data: {{ distribution_data|tojson }},
                backgroundColor: [
                    '#17a2b8',
                    '#28a745',
                    '#6f42c1',
                    '#dc3545'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Post filter functionality for intern performance
    document.getElementById('postFilter').addEventListener('change', function() {
        filterInterns();
    });
    
    // POC filter functionality for intern performance
    document.getElementById('pocFilter').addEventListener('change', function() {
        filterInterns();
    });
    
    // Performance filter functionality for intern performance
    document.getElementById('performanceFilter').addEventListener('change', function() {
        filterInterns();
    });
    
    // Team filter functionality
    document.getElementById('teamFilter').addEventListener('change', function() {
        const selectedTeam = this.value;
        const teamCards = document.querySelectorAll('.team-card');
        
        if (selectedTeam === 'all') {
            teamCards.forEach(card => {
                card.style.display = 'block';
            });
        } else {
            teamCards.forEach(card => {
                const teamName = card.getAttribute('data-team');
                card.style.display = teamName === selectedTeam ? 'block' : 'none';
            });
        }
    });
    
    // Combined filter function for interns
    function filterInterns() {
        const selectedPost = document.getElementById('postFilter').value;
        const selectedPoc = document.getElementById('pocFilter').value;
        const selectedPerformance = document.getElementById('performanceFilter').value;
        const internCards = document.querySelectorAll('.intern-card-container');
        
        let visibleCount = 0;
        let totalTndAchieved = 0;
        let totalCategoryAchieved = 0;
        
        internCards.forEach(card => {
            // Post filtering
            let showByPost = selectedPost === 'all';
            if (!showByPost) {
                const post = card.getAttribute('data-post');
                showByPost = post === selectedPost;
            }
            
            // POC filtering
            let showByPoc = selectedPoc === 'all';
            if (!showByPoc) {
                const poc = card.getAttribute('data-poc');
                showByPoc = poc === selectedPoc;
            }
            
            // Performance filtering
            let showByPerformance = selectedPerformance === 'all';
            if (!showByPerformance) {
                const performance = parseInt(card.getAttribute('data-performance'));
                if (selectedPerformance === 'high') {
                    showByPerformance = performance > 80;
                } else if (selectedPerformance === 'medium') {
                    showByPerformance = performance >= 50 && performance <= 80;
                } else if (selectedPerformance === 'low') {
                    showByPerformance = performance < 50;
                }
            }
            
            // Show card only if it passes all filters
            const isVisible = showByPost && showByPoc && showByPerformance;
            card.style.display = isVisible ? 'block' : 'none';
            
            // Update counts if visible
            if (isVisible) {
                visibleCount++;
                
                // Add TND and Category achievements
                const tndAchieved = parseInt(card.getAttribute('data-tnd-achieved')) || 0;
                const categoryAchieved = parseInt(card.getAttribute('data-category-achieved')) || 0;
                totalTndAchieved += tndAchieved;
                totalCategoryAchieved += categoryAchieved;
            }
        });
        
        // Update the summary display
        document.getElementById('filteredCount').textContent = visibleCount;
        document.getElementById('filteredTndTotal').textContent = totalTndAchieved;
        document.getElementById('filteredCategoryTotal').textContent = totalCategoryAchieved;
    }
    
    // Calculate initial totals
    function calculateInitialTotals() {
        let totalTndAchieved = 0;
        let totalCategoryAchieved = 0;
        const internCards = document.querySelectorAll('.intern-card-container');
        
        internCards.forEach(card => {
            const tndAchieved = parseInt(card.getAttribute('data-tnd-achieved')) || 0;
            const categoryAchieved = parseInt(card.getAttribute('data-category-achieved')) || 0;
            totalTndAchieved += tndAchieved;
            totalCategoryAchieved += categoryAchieved;
        });
        
        document.getElementById('filteredTndTotal').textContent = totalTndAchieved;
        document.getElementById('filteredCategoryTotal').textContent = totalCategoryAchieved;
    }
    
    // Initialize DataTables
    $(document).ready(function() {
        calculateInitialTotals();
        $('#dataTable').DataTable({
            scrollX: true,
            scrollY: '400px',
            scrollCollapse: true,
            paging: true,
            fixedHeader: true,
            responsive: true
        });
    });
</script>
{% endblock %}